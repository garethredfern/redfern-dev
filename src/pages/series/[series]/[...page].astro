---
import type { Page } from "astro";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }: any) {
  const allArticles = await getCollection("articles");

  const uniqueSeries = [
    ...new Set(
      allArticles
        .filter((article) => article.data.series)
        .map((article) => article.data.series)
    ),
  ];

  return uniqueSeries.flatMap((series) => {
    const filteredArticles = allArticles
      .filter((article) => article.data.series === series)
      .sort((a, b) => (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0));

    return paginate(filteredArticles, {
      params: { series },
      pageSize: 10,
    });
  });
}

type Props = {
  page: Page<any>;
};

const { series } = Astro.params;
const { page } = Astro.props;

function formatSeriesName(slug: string) {
  return slug
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

const seriesName = formatSeriesName(series as string);
const title = `${seriesName} Series`;
const description = `Follow along with the ${seriesName} tutorial series.`;
---

<BaseLayout {title} {description} pagination={{ prev: page.url.prev, next: page.url.next }}>
  <div class="border-b border-white/10 p-5 ml-2 lg:pl-35">
    <h2 class="text-sm text-primary uppercase">Series: {seriesName}</h2>
    <h3 class="text-sm text-primary lowercase">
      {page.total} article{page.total !== 1 ? "s" : ""}
    </h3>
  </div>

  <ul class="px-5 ml-2 lg:ml-30 lg:w-1/2">
    {
      page.data.map((article, index) => (
        <li class="my-2 border-b border-white/10 border-dashed py-2 last:border-0">
          <a
            href={`/articles/${article.id}`}
            class="text-white text-lg hover:underline"
          >
            <span class="text-gray-400 mr-2">
              {String(article.data.seriesOrder || index + 1).padStart(2, "0")}.
            </span>
            {article.data.title}
          </a>
          <p class="text-gray-400 text-sm ml-8">{article.data.description}</p>
        </li>
      ))
    }
  </ul>

  <div
    class="text-primary uppercase flex gap-4 my-5 px-5 ml-2 lg:ml-30 lg:w-1/2"
  >
    {page.url.first && page.url.prev ? <a href={page.url.first}>First</a> : null}
    {page.url.prev ? <a href={page.url.prev}>Prev</a> : null}
    {page.url.next ? <a href={page.url.next}>Next</a> : null}
    {page.url.last && page.url.next ? <a href={page.url.last}>Last</a> : null}
  </div>

  <div class="my-5 px-5 ml-2 lg:ml-30 lg:w-1/2 flex gap-4">
    <a href="/series" class="text-primary uppercase text-sm hover:underline">
      All Series
    </a>
    <a href="/" class="text-primary uppercase text-sm hover:underline">
      All Articles
    </a>
  </div>
</BaseLayout>
