---
import { getCollection, getEntry, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const articles = await getCollection("articles");
  return articles.map((article) => ({
    params: { slug: article.data.link },
  }));
}

const { slug } = Astro.params;
const article = await getEntry("articles", slug);

if (!article) {
  return Astro.error(404, "Article not found");
}

const { Content } = await render(article);
const tags = article.data.tags || [];

// Get series navigation
let prevArticle = null;
let nextArticle = null;
let seriesName = null;

if (article.data.series && article.data.seriesOrder) {
  const allArticles = await getCollection("articles");
  const seriesArticles = allArticles
    .filter((a) => a.data.series === article.data.series)
    .sort((a, b) => (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0));

  const currentIndex = seriesArticles.findIndex(
    (a) => a.data.link === article.data.link
  );

  if (currentIndex > 0) {
    prevArticle = seriesArticles[currentIndex - 1];
  }
  if (currentIndex < seriesArticles.length - 1) {
    nextArticle = seriesArticles[currentIndex + 1];
  }

  seriesName = article.data.series
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}
---

<BaseLayout title={article.data.title} description={article.data.description}>
  <article>
    <header class="border-b border-white/10 p-5 ml-2 lg:pl-35">
      <p class="text-sm text-primary uppercase">
        Published on {new Date(article.data.pubDate).toLocaleDateString()}
      </p>
      {
        tags.length > 0 && (
          <p class="text-sm text-primary lowercase">
            Tags:{" "}
            {tags.map((tag, index) => (
              <>
                <a href={`/tags/${tag}`} class="hover:underline">
                  {tag}
                </a>
                {index < tags.length - 1 && ", "}
              </>
            ))}
          </p>
        )
      }
    </header>
    <div
      class="text-white prose prose-invert max-w-4xl px-5 ml-2 lg:ml-30 lg:w-2/3"
    >
      <div>
        <Content />
      </div>
    </div>
    {
      (prevArticle || nextArticle) && (
        <nav class="my-8 px-5 ml-2 lg:ml-30 lg:w-2/3 border-t border-white/10 pt-6">
          <p class="text-xs text-gray-400 uppercase mb-4">
            Series: {seriesName}
          </p>
          <div class="flex justify-between gap-4 text-sm">
            <div class="flex-1">
              {prevArticle && (
                <a
                  href={`/articles/${prevArticle.data.link}`}
                  class="block group"
                >
                  <span class="text-xs text-gray-400 uppercase">Previous</span>
                  <span class="block text-primary group-hover:underline">
                    {prevArticle.data.title}
                  </span>
                </a>
              )}
            </div>
            <div class="flex-1">
              {nextArticle && (
                <a
                  href={`/articles/${nextArticle.data.link}`}
                  class="block group"
                >
                  <div class="text-xs text-gray-400 uppercase">Next</div>
                  <div class="block text-primary group-hover:underline">
                    {nextArticle.data.title}
                  </div>
                </a>
              )}
            </div>
          </div>
        </nav>
      )
    }

    <div class="my-5 px-5 ml-2 lg:ml-30 lg:w-2/3">
      <a href="/" class="text-primary uppercase text-sm hover:underline">
        Back to Articles
      </a>
    </div>
  </article>
</BaseLayout>
